{% if user.is_authenticated %}
    {% block messages %}
        {% include 'adminlte/lib/_messages.html' %}
    {% endblock %}

    <div class="col">
        {% block form_modal_dependencia %}
            <form id="modal_form_dependencia_agregar" action="" method="post">
                <div id="dependencia_errors"></div>
                {{ modal_form_dependencia_agregar.errors }}
                {% csrf_token %}

                <p><strong>Nombre de la dependencia:</strong>
                    <a href="#" data-toggle="tooltip" data-placement="bottom"
                       title="Nombre de la dependencia. Agregar después del nombre sus siglas entre paréntesis (si tiene siglas),
               por ejemplo: Centro de Investigaciones en Geografía Ambiental (CIGA).">
                        <i class="fa fa-question-circle"></i></a> <i class="fa fa-edit"></i>
                <div class="form-group" style="margin-top: -10px;">
                    <div class="input-group">
                        <div class="input-group-addon">
                            <i class="fa fa-pencil-square-o"></i>
                        </div>
                        {{ modal_form_dependencia_agregar.nombre_dependencia }}
                    </div>
                </div>
                </p>
                <p><strong>Institución a la que pertenece:</strong>
                    <a href="#" data-toggle="tooltip" data-placement="right"
                       title="Institución a la que pertenene la dependencia.">
                        <i class="fa fa-question-circle"></i>
                    </a> <i class="fa fa-edit"></i>
                <div class="form-group" style="margin-top: -10px;">
                    <div class="input-group">
                        <div class="input-group-addon"><i class="fa fa-list-alt"></i></div>
                        {{ modal_form_dependencia_agregar.institucion_dependencia }}
                        <div class="input-group-addon">
                            <a href="#" data-toggle="tooltip" data-placement="left"
                               title="Mostrar los detalles adicionales de la institución.">
                                <i class="fa fa-eye"></i>
                            </a>
                        </div>
                        <div class="input-group-addon">
                                <span data-toggle="modal" data-target="#agregar-institucion">
                                    <a data-toggle="tooltip" data-placement="left" style="cursor: pointer;" }
                                       title="Agregar una institución nueva cuando no existe en los registros.">
                                    <i class="fa fa-plus"></i>
                                    </a>
                                </span>
                        </div>
                    </div>
                </div>
                </p>
                <div id="d_subsunam">
                    <p><strong>Subsistema UNAM:</strong>
                        <a href="#" data-toggle="tooltip" data-placement="right"
                           title="En caso de que la dependencia sea perteneciente a la UNAM y esté adscrita a algún subsistema de la UNAM seleccionarlo de la lista, de lo contrario dejar en blanco.">
                            <i class="fa fa-question-circle"></i>
                        </a>
                    <div class="form-group" style="margin-top: -10px;">
                        <div class="input-group">
                            <div class="input-group-addon"><i class="fa fa-list-alt"></i></div>
                            {{ modal_form_dependencia_agregar.subsistema_unam_dependencia }}
                        </div>
                    </div>
                    </p>
                </div>
                <p><strong>Ciudad:</strong>
                    <a href="#" data-toggle="tooltip" data-placement="right"
                       title="Ciudad donde se encuentra la dependencia."><i
                            class="fa fa-question-circle"></i></a> <i class="fa fa-edit"></i>
                <div class="form-group" style="margin-top: -10px;">
                    <div class="input-group">
                        <div class="input-group-addon">
                            <i class="fa fa-pencil-square-o"></i>
                        </div>
                        {{ modal_form_dependencia_agregar.ciudad_text_dependencia }}
                    </div>
                </div>
                </p>


                <!-- button id="agregar-dependencia-submit" type="submit" class="btn btn-success">Guardar</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal">Cancelar</button>
                <input type="submit" tabindex="-1" style="position:absolute; top:-1000px"> -->
            </form>

            <script>
                if ($("#id_institucion_dependencia").val() != 1) {
                    console.log("esconder inicio")
                    $('#d_subsunam').hide();
                } else {
                    $('#d_subsunam').show();
                }


                $("#id_institucion_dependencia").on('change', function () {
                    if ($("#id_institucion_dependencia").val() == 1) {
                        $('#d_subsunam').show('slow');
                    } else {
                        console.log("esconder cambio")
                        $('#d_subsunam').hide('slow');
                        $('#id_subsistema_unam_dependencia').val(null).trigger('change');
                    }
                });

                $("#modal_form_dependencia_agregar").submit(function (event) {
                    console.log("Handler for .submit() called.");
                    var datos = {
                        nombre_dependencia: $("#id_nombre_dependencia").val(),
                        institucion_dependencia: parseInt($("#id_institucion_dependencia").val()),
                        ciudad_text_dependencia: $("#id_ciudad_text_dependencia").val(),
                        usuario_creador: {{ user.pk }},
                    };
                    if ($("#id_subsistema_unam_dependencia").val() != "") {
                        datos.subsistema_unam_dependencia = $("#id_subsistema_unam_dependencia").val();
                    }
                    $crf_token = $('[name="csrfmiddlewaretoken"]').attr('value');
                    $.ajax({
                        type: "POST",
                        url: "/nucleo/rest/dependencias/",
                        dataType: 'json',
                        data: datos,
                        headers: {"X-CSRFToken": $crf_token},
                        error: function (xhr, ajaxOptions, thrownError) {
                            //console.log(xhr.responseJSON.non_field_errors[0])
                            console.log(xhr.responseJSON)
                            console.log("{{ user.get_username }}")
                            console.log("{{ user.pk }}")
                            console.log("{{ user }}")

                            errores_form = '<div class="alert alert-danger alert-dismissible fade1 show" role="alert">' +
                                '  <p><strong>Se encontraron los siguientes errores:</strong><br /></p><ul>';


                            if (xhr.responseJSON.hasOwnProperty('nombre_dependencia')) {
                                if (xhr.responseJSON.ciudad_text_dependencia == "Este campo no puede estar en blanco.") {
                                    errores_form += "<li>El nombre de la dependencia no puede estar en blanco</li>"
                                }
                            }
                            if (xhr.responseJSON.hasOwnProperty('ciudad_text_dependencia')) {
                                if (xhr.responseJSON.ciudad_text_dependencia == "Este campo no puede estar en blanco.") {
                                    errores_form += "<li>El campo de ciudad no puede estar en blanco</li>"
                                }
                            }
                            if (xhr.responseJSON.hasOwnProperty('institucion_dependencia')) {
                                if (xhr.responseJSON.institucion_dependencia == "Tipo incorrecto. Se esperaba valor de clave primaria y se recibió str.") {
                                    errores_form += "<li>El campo de institución no puede estar en blanco</li>"
                                }
                            }
                            if (xhr.responseJSON.hasOwnProperty('non_field_errors')) {
                                if (xhr.responseJSON.non_field_errors == "Los campos nombre_dependencia, institucion_dependencia deben formar un conjunto único.") {
                                    errores_form += "<li>Los campos <strong>Nombre de la dependencia</strong> e <strong>Institución a la que pertenece</strong> deben formar un conjunto único. Es decir, ya existe un registro con esta combinación de dependencia e institución.</li>"
                                }
                            }

                            errores_form += '</ul><button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
                                '    <span aria-hidden="true">&times;</span>' +
                                '  </button>' +
                                '</div>'

                            $("#dependencia_errors").html(errores_form);

                        },
                        success: function (data) {
                            console.log("success")
                            $('#id_subsistema_unam_dependencia').val(null).trigger('change');
                            $('#id_institucion_dependencia').val(null).trigger('change');
                            $('#id_institucion_dependencia').children('option').remove();
                            $('#d_subsunam').hide('slow');
                            $('#modal_form_dependencia_agregar').trigger('reset');

                            var nueva_dependencia_institucion = ""
                            console.log(nueva_dependencia_institucion)
                            var insturl = "/nucleo/rest/instituciones/" + data.institucion_dependencia.toString() + "/"
                            $.ajax({
                                url: insturl,
                                success: function (dataf) {
                                    console.log(dataf.nombre_institucion);
                                    nueva_dependencia_institucion = dataf.nombre_institucion.toString();
                                    console.log(nueva_dependencia_institucion)
                                    var nueva_dependencia = new Option(data.nombre_dependencia + " :: " + nueva_dependencia_institucion, data.id, true, true);
                                    $('#id_dependencia').append(nueva_dependencia).trigger('change');
                                    $('#agregar-dependencia-modal-body').empty();
                                    agregar_dependencia_dialog.dialog("close")
                                }
                            });
                        }
                    });
                    event.preventDefault();
                });
            </script>
        {% endblock %}
    </div>

{% else %}
    <script>
        window.location.href = '/login/';
    </script>
{% endif %}