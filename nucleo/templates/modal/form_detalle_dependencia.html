{% extends 'modal/main_modal.html' %}

{% block form_modal %}
    <form id="modal_form_detalle" action="" method="post">
        {% csrf_token %}
        <p><strong>Nombre de la dependencia detalle:</strong>
            <a href="#" data-toggle="tooltip" data-placement="right"
               title="Nombre de la dependencia. Agregar después del nombre sus siglas entre paréntesis (si tiene siglas),
               por ejemplo: Centro de Investigaciones en Geografía Ambiental (CIGA).">
                <i class="fa fa-question-circle"></i></a>
        <div class="form-group" style="margin-top: -10px;">
            <div class="input-group date">
                <div class="input-group-addon">
                    <i class="fa fa-pencil-square-o"></i>
                </div>
                {{ modal_form.nombre_dependencia }}
            </div>
        </div>
        </p>
        <p><strong>Descripción: <a href="#" data-toggle="tooltip" data-placement="right"
                                   title="Descripción detallada adicional, por ejemplo información que no está contemplada en los demás campos.">
            <i class="fa fa-question-circle"></i></a></strong>
            {{ modal_form.descripcion_dependencia }}
        </p>
        <p><strong>Ciudad:</strong>
            <a href="#" data-toggle="tooltip" data-placement="right"
               title="Ciudad donde se encuentra la dependencia."><i
                    class="fa fa-question-circle"></i></a>
        <div class="form-group" style="margin-top: -10px;">
            <div class="input-group date">
                <div class="input-group-addon">
                    <i class="fa fa-pencil-square-o"></i>
                </div>
                {{ modal_form.ciudad_text_dependencia }}
            </div>
        </div>
        </p>
        <p><strong>Institución a la que pertenece:</strong>
            <a href="#" data-toggle="tooltip" data-placement="right"
               title="Institución a la que pertenene la dependencia.">
                <i class="fa fa-question-circle"></i>
            </a> <i class="fa fa-edit"></i>
        <div class="form-group" style="margin-top: -10px;">
            <div class="input-group">
                <div class="input-group-addon"><i class="fa fa-list-alt"></i></div>
                {{ modal_form.institucion_dependencia }}
                <div class="input-group-addon">
                    <a href="#" data-toggle="tooltip" data-placement="left"
                       title="Mostrar los detalles adicionales de la institución.">
                        <i class="fa fa-eye"></i>
                    </a>
                </div>
                <div class="input-group-addon">
                    <a href="/nucleo/instituciones" data-toggle="tooltip" data-placement="left" target="_blank"
                       title="Agregar una institución nueva. Cuando no existe en los registros, aquí se puede dar de alta.">
                        <i class="fa fa-plus"></i>
                    </a>
                </div>
            </div>
        </div>
        </p>
        <div id="d_subsunam">
            <p><strong>Subsistema UNAM:</strong>
                <a href="#" data-toggle="tooltip" data-placement="right"
                   title="En caso de que la dependencia sea perteneciente a la UNAM y esté adscrita a algún subsistema de la UNAM seleccionarlo de la lista, en caso contrario seleccionar 'No'.">
                    <i class="fa fa-question-circle"></i>
                </a> <i class="fa fa-edit"></i>
            <div class="form-group" style="margin-top: -10px;">
                <div class="input-group">
                    <div class="input-group-addon"><i class="fa fa-list-alt"></i></div>
                    {{ modal_form.subsistema_unam_dependencia }}
                </div>
            </div>
            </p>
        </div>

        <button id="guardar-dependencia-submit" type="submit" class="btn btn-success">Guardar</button>
        <button type="button" class="btn btn-primary" data-dismiss="modal">Cancelar</button>
    </form>

    <script>
        if ($("#id_institucion_dependencia").val() != 1) {
            $('#d_subsunam').hide();
        }

        $("#id_institucion_dependencia").on('change', function () {
            if ($("#id_institucion_dependencia").val() == 1) {
                $('#d_subsunam').show('slow');
            } else {
                $('#d_subsunam').hide('slow');
                $('#id_subsistema_unam_dependencia').val(null).trigger('change');
            }
        });



        $("#modal_form_detalle").submit(function (event) {
            console.log("Handler for .submit() called editar.");

            var datos = {
                nombre_dependencia: $("#id_nombre_dependencia").val(),
                institucion_dependencia: parseInt($("#id_institucion_dependencia").val()),
                ciudad_text_dependencia: $("#id_ciudad_text_dependencia").val(),
            };
            if ($("#id_subsistema_unam_dependencia").val() != "") {
                datos.subsistema_unam_dependencia = $("#id_subsistema_unam_dependencia").val();
            }
            $crf_token = $('[name="csrfmiddlewaretoken"]').attr('value');
            var patchurl = "/nucleo/rest/dependencias/" + $("#id_dependencia").val().toString() + "/";
            console.log(patchurl);
            $.ajax({
                type: "PATCH", url: patchurl, dataType: 'json', data: datos, headers: {"X-CSRFToken": $crf_token},
                error: function (xhr, ajaxOptions, thrownError) {
                    $('#id_subsistema_unam_dependencia').val(null).trigger('change');
                    $('#id_institucion_dependencia').val(null).trigger('change');
                    $('#id_institucion_dependencia').children('option').remove();
                    $('#d_subsunam').hide('slow');
                    $('#modal_form').trigger('reset');
                },
                success: function (data) {
                    $('#id_subsistema_unam_dependencia').val(null).trigger('change');
                    $('#id_institucion_dependencia').val(null).trigger('change');
                    $('#id_institucion_dependencia').children('option').remove();
                    $('#d_subsunam').hide('slow');
                    $('#modal_form_detalle').trigger('reset');

                    var nueva_dependencia_institucion = ""

                    var insturl = "/nucleo/rest/instituciones/" + data.institucion_dependencia.toString() + "/"
                    $.ajax({
                        url: insturl,
                        success: function (dataf) {
                            console.log(dataf.nombre);
                            nueva_dependencia_institucion = dataf.nombre.toString();
                            console.log(nueva_dependencia_institucion)
                            var nueva_dependencia = new Option(data.nombre_dependencia + " :: " + nueva_dependencia_institucion, data.id, true, true);
                            $('#id_dependencia').append(nueva_dependencia).trigger('change');
                            $('#detalle-dependencia').modal('toggle');
                            $('#detalle-dependencia-modal-body').empty();
                            $('#dependencia-modal-body').empty();
                        }
                    });
                }
            });
            event.preventDefault();
        });
    </script>
    {{ modal_form.media.js }}
{% endblock %}
